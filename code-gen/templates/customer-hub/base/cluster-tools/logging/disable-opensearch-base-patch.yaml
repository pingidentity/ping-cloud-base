# Overwrite the configMap fluent-bit-pipeline-outputs
# config in order to disable the main(opensearch) pipeline.
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-pipeline-outputs
  namespace: elastic-stack-logging
data:
 pipeline-outputs.conf: |
    [OUTPUT]
        Name                http
        Alias               logstash_customer_out
        Match               elk.kube.*
        Host                logstash-elastic.elastic-stack-logging
        Port                8084
        Format              json
        Retry_Limit         False
        compress            gzip
        net.keepalive_idle_timeout  10
        net.keepalive_max_recycle   100
        storage.total_limit_size  3000M

    [OUTPUT]
        Name                http
        Alias               s3_app_out
        Match               *
        Host                logstash-elastic.elastic-stack-logging
        Port                8081
        Format              json
        Retry_Limit         False
        compress            gzip
        net.keepalive_idle_timeout  10
        net.keepalive_max_recycle   100
        storage.total_limit_size  3000M

---
# original port is 8080
# that port is turned off as the main pipeline forwards logs to opensearch
# 8081 is used by the s3 bucket pipeline
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: logstash-elastic
  namespace: elastic-stack-logging
spec:
  template:
    spec:
      containers:
      - name: logstash
        readinessProbe:
          httpGet:
            port: 8081
        startupProbe:
          httpGet:
            port: 8081
        volumeMounts:
        - name: logstash-pipelines
          mountPath: /usr/share/logstash/config/pipelines.yml
          subPath: pipelines.yml
      volumes:
      - name: logstash-pipelines
        configMap:
          name: logstash-pipelines
          items:
          - key: pipelines.yml
            path: pipelines.yml 
