#######################################################################################################
#
# Karpenter CRD patches to get around k8s annotation limits and allow ArgoCD to update the karpenter CRDs without manual intervention
#
# ServerSideApply and Replace were necessary to get around k8s annotation limits since Karpenter CRDs are large resoruces
#
# Karpenter CRD patch for version 1.0.11 since karpenter-crd helm chart does not support adding annotations which are necessary
# for ArgoCD to sync Karpenter CRDs first before other Kaprenter resources that depend on the CRDs being present.
# This is fixed in karpenter-crd helm chart v1.2.0+
#
########################################################################################################

apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: nodeclaims.karpenter.sh
  annotations:
    argocd.argoproj.io/sync-options: ServerSideApply=true,Replace=true
    argocd.argoproj.io/sync-wave: "-10"
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: ec2nodeclasses.karpenter.k8s.aws
  annotations:
    argocd.argoproj.io/sync-options: ServerSideApply=true,Replace=true
    argocd.argoproj.io/sync-wave: "-10"
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: nodepools.karpenter.sh
  annotations:
    argocd.argoproj.io/sync-options: ServerSideApply=true,Replace=true
    argocd.argoproj.io/sync-wave: "-10"