# this file has been patched to send output to s3 instead of cloudwatch. This file will be removed in 1.19.1.0 when the actual change is deployed

# Kubernetes inputs
[INPUT]
    Name                tail
    Tag                 cw.kube.*
    Path                /var/log/containers/*_argo-events_*.log, /var/log/containers/*_argocd*.log
    multiline.parser    docker, cri
    DB                  /fluent-bit/state/flb_cw_argo.db
    Skip_Long_Lines     Off
    Refresh_Interval    10
    Rotate_Wait         30
    storage.type        filesystem
    Read_from_Head      ${READ_FROM_HEAD}
    storage.pause_on_chunks_overlimit on

[INPUT]
    Name                tail
    Tag                 cw.kube.*
    Path                /var/log/containers/*_cert-manager_*.log
    multiline.parser    docker, cri
    DB                  /fluent-bit/state/flb_cw_cert.db
    Skip_Long_Lines     Off
    Refresh_Interval    10
    Rotate_Wait         30
    storage.type        filesystem
    Read_from_Head      ${READ_FROM_HEAD}
    storage.pause_on_chunks_overlimit on

[INPUT]
    Name                tail
    Tag                 cw.kube.*
    Path                /var/log/containers/*_elastic-stack-logging_*.log
    Exclude_Path        *bootstrap*.log
    multiline.parser    docker, cri
    DB                  /fluent-bit/state/flb_cw_elastic.db
    Skip_Long_Lines     Off
    Refresh_Interval    10
    Rotate_Wait         30
    storage.type        filesystem
    Read_from_Head      ${READ_FROM_HEAD}
    storage.pause_on_chunks_overlimit on

[INPUT]
    Name                tail
    Tag                 cw.kube.*
    Path                /var/log/containers/*_external-dns_*.log
    multiline.parser    docker, cri
    DB                  /fluent-bit/state/flb_cw_dns.db
    Skip_Long_Lines     Off
    Refresh_Interval    10
    Rotate_Wait         30
    storage.type        filesystem
    Read_from_Head      ${READ_FROM_HEAD}
    storage.pause_on_chunks_overlimit on

[INPUT]
    Name                tail
    Tag                 cw.kube.*
    Path                /var/log/containers/*_kube-system_*.log
    multiline.parser    docker, cri
    DB                  /fluent-bit/state/flb_cw_system.db
    Skip_Long_Lines     Off
    Refresh_Interval    10
    Rotate_Wait         30
    storage.type        filesystem
    Read_from_Head      ${READ_FROM_HEAD}
    storage.pause_on_chunks_overlimit on

[INPUT]
    Name                tail
    Tag                 cw.kube.*
    Path                /var/log/containers/p14c-*.log
    multiline.parser    docker, cri
    DB                  /fluent-bit/state/flb_cw_p14c.db
    Skip_Long_Lines     Off
    Refresh_Interval    10
    Rotate_Wait         30
    storage.type        filesystem
    Read_from_Head      ${READ_FROM_HEAD}
    storage.pause_on_chunks_overlimit on

[INPUT]
    Name                tail
    Tag                 cw.kube.*
    Path                /var/log/containers/*_pod-reaper_*.log
    multiline.parser    docker, cri
    DB                  /fluent-bit/state/flb_cw_reaper.db
    Skip_Long_Lines     Off
    Refresh_Interval    10
    Rotate_Wait         30
    storage.type        filesystem
    Read_from_Head      ${READ_FROM_HEAD}
    storage.pause_on_chunks_overlimit on

[INPUT]
    Name                tail
    Tag                 cw.kube.*
    Path                /var/log/containers/*alertmanager*.log
    multiline.parser    docker, cri
    DB                  /fluent-bit/state/flb_cw_alertmanager.db
    Skip_Long_Lines     Off
    Refresh_Interval    10
    Rotate_Wait         30
    storage.type        filesystem
    Read_from_Head      ${READ_FROM_HEAD}
    storage.pause_on_chunks_overlimit on

# Kubernetes filters
[FILTER]
    Name                kubernetes
    Match               cw.kube.*
    Kube_URL            https://kubernetes.default.svc:443
    Kube_Tag_Prefix     cw.kube.var.log.containers.
    K8S-Logging.Parser  On
    K8S-Logging.Exclude Off
    Annotations         Off
    Labels              Off
    Buffer_Size         512k
    Cache_Use_Docker_Id On
    Kube_Meta_Cache_TTL 1800
    Use_Kubelet         On


[FILTER]
    Name                lua
    Match               cw.kube.*
    script              record_modifier.lua
    call                record_modifier

[FILTER]
    Name                rewrite_tag
    Match               cw.kube.*
    Rule                $log ^.*$ $stream_name.cw_out false
    Emitter_Name        kube_CW_logs
    Emitter_Storage.type    filesystem
    Emitter_Mem_Buf_Limit   50M

[FILTER]
    Name                record_modifier
    Match               *.cw_out
    Remove_key          stream_name

# Outputs

[OUTPUT]
    Name                s3
    Alias               cw_out
    Match               *.cw_out
    Bucket              ${S3_BUCKET_NAME}
    Region              ${AWS_REGION}
    s3_key_format       /application/cw/%Y/%m/%d/%H/%M/%S
    s3_key_format_tag_delimiters .
    upload_timeout      10s
    Retry_Limit         False
    store_dir_limit_size 1500M
    store_dir           /fluent-bit/store/s3
    upload_chunk_size   20M
    total_file_size     500M
    workers             1
