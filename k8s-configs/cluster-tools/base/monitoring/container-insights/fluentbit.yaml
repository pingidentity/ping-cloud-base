# create configmap for cluster name and aws region for CloudWatch Logs
# need to replace the placeholders cluster_name and region_name
apiVersion: v1
data:
  cluster.name: cluster_name
  logs.region: region_name
  log.level: "error"
  read.head: "True"
  read.tail: "True"
kind: ConfigMap
metadata:
  name: cluster-info
  namespace: amazon-cloudwatch
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: fluent-bit
  namespace: amazon-cloudwatch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: fluent-bit-role
rules:
  - nonResourceURLs:
      - /metrics
    verbs:
      - get
  - apiGroups: [""]
    resources:
      - namespaces
      - pods
      - pods/logs
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: fluent-bit-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: fluent-bit-role
subjects:
  - kind: ServiceAccount
    name: fluent-bit
    namespace: amazon-cloudwatch
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: amazon-cloudwatch
  labels:
    k8s-app: fluent-bit
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush                     5
        Daemon                    off
        Parsers_File              parsers.conf
        storage.path              /fluent-bit/state/flb-storage/
        storage.sync              normal
        storage.checksum          off
        storage.backlog.mem_limit 5M
        
    @INCLUDE ping-log.conf
    @INCLUDE nonping-log.conf
    @INCLUDE dataplane-log.conf
    @INCLUDE host-log.conf
    @INCLUDE outputs.conf

  ping-log.conf: |
    [INPUT]
        Name                tail
        Tag                 ping.*
        Path                /var/log/containers/ping*, /var/log/containers/p14c*
        multiline.parser    docker, cri
        DB                  /fluent-bit/state/flb_ping.db
        Mem_Buf_Limit       50MB
        Skip_Long_Lines     Off
        Refresh_Interval    10
        Rotate_Wait         30
        storage.type        filesystem
        Read_from_Head      ${READ_FROM_HEAD}

    # Multiline exceptions
    [FILTER]
        Name                  multiline
        match                 ping.*  
        multiline.key_content log
        multiline.parser      multiline_java_log
    
    [FILTER]
        Name                kubernetes
        Match               ping.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_Tag_Prefix     ping.var.log.containers.
        Merge_Log           On
        Merge_Log_Key       log_processed
        K8S-Logging.Parser  On
        K8S-Logging.Exclude Off
        Annotations         Off
    
    [FILTER]
        Name                lua
        Match               ping.*
        script              record_modifier.lua
        call                record_modifier
    
    # Exclude DA healthcheck logs
    [FILTER]
        Name                grep
        Match               ping.*
        Exclude             log ^<\d+.>|^\/opt\/out\/instance\/logs\/access.*127\.0\.0\.1.*GET \/ HTTP\/2\.0.*200
    
    # Exclude apps healthcheck logs
    [FILTER]
        Name                grep
        Match               ping.*
        Exclude             log ^<\d+.>|^\/opt\/out\/instance\/log\/.*api.*127\.0\.0\.1\| GET\| .*\/version\| 200

    # PA/PAWAS/DA
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/pingaccess_api_audit pingaccess_api_audit_logs.$stream_name false
        Emitter_Name        pingaccess_api_audit_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/pingaccess_agent_audit pingaccess_agent_audit_logs.$stream_name false
        Emitter_Name        pingaccess_agent_audit_logs

    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/pingaccess_engine_audit pingaccess_engine_audit_logs.$stream_name false
        Emitter_Name        pingaccess_engine_audit_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/pingaccess_sideband_client_audit pingaccess_sideband_client_audit_logs.$stream_name false
        Emitter_Name        pingaccess_sideband_client_audit_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/pingaccess_sideband_audit pingaccess_sideband_audit_logs.$stream_name false
        Emitter_Name        pingaccess_sideband_audit_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/pingaccess pingaccess_logs.$stream_name false
        Emitter_Name        pingaccess_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/upgrade\/log\/audit pingaccess_upgrade_audit_logs.$stream_name false
        Emitter_Name        pingaccess_upgrade_audit_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/upgrade\/log\/upgrade_status pingaccess_upgrade_status_logs.$stream_name false
        Emitter_Name        pingaccess_upgrade_status_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/upgrade\/log\/upgrade pingaccess_upgrade_logs.$stream_name false
        Emitter_Name        pingaccess_upgrade_logs
    
    # PD
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/logs\/server server_logs.$stream_name false
        Emitter_Name        server_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/logs\/access access_logs.$stream_name false
        Emitter_Name        access_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/logs\/errors errors_logs.$stream_name false
        Emitter_Name        errors_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/logs\/change-notifications change_notifications_logs.$stream_name false
        Emitter_Name        change_notifications_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/logs\/failed-ops failed_ops_logs.$stream_name false
        Emitter_Name        failed_ops_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/logs\/expensive-write-ops expensive_write_ops_logs.$stream_name false
        Emitter_Name        expensive_write_ops_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/logs\/replication replication_logs.$stream_name false
        Emitter_Name        replication_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/logs\/config-audit config_audit_logs.$stream_name false
        Emitter_Name        config_audit_logs
    
    # PDSync   
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/logs\/sync-failed-ops sync_failed_ops_logs.$stream_name false
        Emitter_Name        sync_failed_ops_logs
    
    # PF
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/admin-api admin_api_logs.$stream_name false
        Emitter_Name        admin_api_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/admin-event-detail admin_event_detail_logs.$stream_name false
        Emitter_Name        admin_event_detail_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/admin admin_logs.$stream_name false
        Emitter_Name        admin_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/runtime-api runtime_api_logs.$stream_name false
        Emitter_Name        runtime_api_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/transaction transaction_logs.$stream_name false
        Emitter_Name        transaction_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/audit audit_logs.$stream_name false
        Emitter_Name        audit_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/provisioner-audit provisioner_audit_logs.$stream_name false
        Emitter_Name        provisioner_audit_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/provisioner provisioner_logs.$stream_name false
        Emitter_Name        provisioner_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/init init_logs.$stream_name false
        Emitter_Name        init_logs
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/jvm-garbage-collection jvm_garbage_collection_logs.$stream_name false
        Emitter_Name        jvm_garbage_collection_logs
    
    # PC
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/application-api pingcentral_application_api.$stream_name false
        Emitter_Name        pingcentral_application_api
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/application-ext pingcentral_application_ext.$stream_name false
        Emitter_Name        pingcentral_application_ext
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/application pingcentral_application.$stream_name false
        Emitter_Name        pingcentral_application
    
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/log\/monitor pingcentral_monitor.$stream_name false
        Emitter_Name        pingcentral_monitor
    
    # DA
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^\/opt\/out\/instance\/logs\/error error_logs.$stream_name false
        Emitter_Name        error_logs
    
    # Everything else
    [FILTER]
        Name                rewrite_tag
        Match               ping.*
        Rule                $log ^.*$ $stream_name false
        Emitter_Name        unmatched_logs

  nonping-log.conf: |
    [INPUT]
        Name                tail
        Tag                 nonping.*
        Exclude_Path        /var/log/containers/cloudwatch-agent*, /var/log/containers/fluent-bit*, /var/log/containers/aws-node*, /var/log/containers/kube-proxy*, /var/log/containers/ping*, /var/log/containers/p14c*
        Path                /var/log/containers/*
        multiline.parser    docker, cri
        DB                  /fluent-bit/state/flb_nonping.db
        Mem_Buf_Limit       50MB
        Skip_Long_Lines     Off
        Refresh_Interval    10
        Rotate_Wait         30
        storage.type        filesystem
        Read_from_Head      ${READ_FROM_HEAD}
    
    [INPUT]
        Name                tail
        Tag                 nonping.*
        Path                /var/log/containers/fluent-bit*
        Parser              docker
        DB                  /fluent-bit/state/flb_log.db
        Mem_Buf_Limit       5MB
        Skip_Long_Lines     Off
        Refresh_Interval    10
        Read_from_Head      ${READ_FROM_HEAD}

    [INPUT]
        Name                tail
        Tag                 nonping.*
        Path                /var/log/containers/cloudwatch-agent*
        Docker_Mode         On
        Docker_Mode_Flush   5
        Docker_Mode_Parser  cwagent_firstline
        Parser              docker
        DB                  /fluent-bit/state/flb_cwagent.db
        Mem_Buf_Limit       5MB
        Skip_Long_Lines     Off
        Refresh_Interval    10
        Read_from_Head      ${READ_FROM_HEAD}
    
    [FILTER]
        Name                kubernetes
        Match               nonping.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_Tag_Prefix     nonping.var.log.containers.
        Merge_Log           On
        Merge_Log_Key       log_processed
        K8S-Logging.Parser  On
        K8S-Logging.Exclude Off
        Annotations         Off

    [FILTER]
        Name                lua
        Match               nonping.*
        script              record_modifier.lua
        call                record_modifier
    
    # Everything else
    [FILTER]
        Name                rewrite_tag
        Match               nonping.*
        Rule                $log ^.*$ $stream_name false
        Emitter_Name        unmatched_nonping_logs

  dataplane-log.conf: |
    [INPUT]
        Name                systemd
        Tag                 dataplane.systemd.*
        Systemd_Filter      _SYSTEMD_UNIT=docker.service
        Systemd_Filter      _SYSTEMD_UNIT=kubelet.service
        DB                  /fluent-bit/state/systemd.db
        Path                /var/log/journal
        Read_From_Tail      ${READ_FROM_TAIL}

    [FILTER]
        Name                modify
        Match               dataplane.systemd.*
        Rename              _HOSTNAME                   hostname
        Rename              _SYSTEMD_UNIT               systemd_unit
        Rename              MESSAGE                     message
        Remove_regex        ^((?!hostname|systemd_unit|message).)*$

    [FILTER]
        Name                aws
        Match               dataplane.*
        imds_version        v1
    
  host-log.conf: |
    [INPUT]
        Name                tail
        Tag                 host.dmesg
        Path                /var/log/dmesg
        Parser              dmesg
        DB                  /fluent-bit/state/flb_dmesg.db
        Mem_Buf_Limit       5MB
        Skip_Long_Lines     On
        Refresh_Interval    10
        Read_from_Head      ${READ_FROM_HEAD}

    [INPUT]
        Name                tail
        Tag                 host.messages
        Path                /var/log/messages
        Parser              syslog
        DB                  /fluent-bit/state/flb_messages.db
        Mem_Buf_Limit       5MB
        Skip_Long_Lines     On
        Refresh_Interval    10
        Read_from_Head      ${READ_FROM_HEAD}

    [INPUT]
        Name                tail
        Tag                 host.secure
        Path                /var/log/secure
        Parser              syslog
        DB                  /fluent-bit/state/flb_secure.db
        Mem_Buf_Limit       5MB
        Skip_Long_Lines     On
        Refresh_Interval    10
        Read_from_Head      ${READ_FROM_HEAD}

    [FILTER]
        Name                aws
        Match               host.*
        private_ip          true
        imds_version        v1
    
    [FILTER]
        Name                lua
        Match               host.*
        script              time.lua
        call                append_tag

  parsers.conf: |
    [PARSER]
        Name                docker
        Format              json
        Time_Key            time
        Time_Format         %Y-%m-%dT%H:%M:%S.%LZ
    
    [PARSER]
        Name                dmesg
        Format              regex
        Regex               ^\[.*\](?<message>.*)$

    [PARSER]
        Name                syslog
        Format              regex
        Regex               ^(?<time>[^ ]* {1,2}[^ ]* [^ ]*) (?<host>[^ ]*) (?<ident>[a-zA-Z0-9_\/\.\-]*)(?:\[(?<pid>[0-9]+)\])?(?:[^\:]*\:)? *(?<message>.*)$
        Time_Key            time
        Time_Format         %b %d %H:%M:%S

    [PARSER]
        Name                container_firstline
        Format              regex
        Regex               (?<log>(?<="log":")\S(?!\.).*?)(?<!\\)".*(?<stream>(?<="stream":").*?)".*(?<time>\d{4}-\d{1,2}-\d{1,2}T\d{2}:\d{2}:\d{2}\.\w*).*(?=})
        Time_Key            time
        Time_Format         %Y-%m-%dT%H:%M:%S.%LZ

    [PARSER]
        Name                cwagent_firstline
        Format              regex
        Regex               (?<log>(?<="log":")\d{4}[\/-]\d{1,2}[\/-]\d{1,2}[ T]\d{2}:\d{2}:\d{2}(?!\.).*?)(?<!\\)".*(?<stream>(?<="stream":").*?)".*(?<time>\d{4}-\d{1,2}-\d{1,2}T\d{2}:\d{2}:\d{2}\.\w*).*(?=})
        Time_Key            time
        Time_Format         %Y-%m-%dT%H:%M:%S.%LZ
    
    [MULTILINE_PARSER]
        Name multiline_java_log
        type regex
        parser json
        key_content log
    
        rule "start_state" "/(?:\/.*\.log) ([0-9\-:T]+,\d+) (ERROR) (.*)/" "cont"
        rule "cont" "/(?:\/.*\.log)[ \t]+(\w+\..*)/" "cont"
        rule "cont" "/(?:\/.*\.log)[ \t]+(at \w+\..*|Caused by:.*|\.\.\. \d+ more)/" "cont"


  outputs.conf: |
    [OUTPUT]
        Name                cloudwatch
        Match               *ping*
        region              ${AWS_REGION}
        log_group_name      /aws/containerinsights/${CLUSTER_NAME}/application
        log_stream_name     $(tag)
        auto_create_group   true     
        extra_user_agent    fluent-bit
    
    [OUTPUT]
        Name                cloudwatch
        Match               host.*
        region              ${AWS_REGION}
        log_group_name      /aws/containerinsights/${CLUSTER_NAME}/host
        log_stream_name     $(tag)-$(host)
        auto_create_group   true
        extra_user_agent    container-insights

    [OUTPUT]
        Name                cloudwatch
        Match               dataplane.systemd.*
        region              ${AWS_REGION}
        log_group_name      /aws/containerinsights/${CLUSTER_NAME}/dataplane
        log_stream_name     $(tag[2]).$(tag[3])-$(hostname)
        auto_create_group   true
        extra_user_agent    container-insight

  time.lua: |
    # This script is called by fluent-bit to append a time to the log message.
    function append_tag(tag, timestamp, record)
      new_record = record
      new_record["time"] = os.date("%Y-%m-%dT%H:%M:%S")
      host = record["private_ip"]:gsub("%.", "-")
      new_record["host"] = "ip-"..host
      return 1, timestamp, new_record
    end
    
  record_modifier.lua: |
    # This script is called by fluent-bit to append a stream_name to the log message.
    function record_modifier(tag, timestamp, record)
      if record["kubernetes"] then
        new_record = record
        new_record["stream_name"] = record["kubernetes"]["pod_name"].."_"..record["kubernetes"]["namespace_name"].."_"..record["kubernetes"]["container_name"]
        return 2, timestamp, new_record
      else
        print(record)
        return 0, 0, 0
      end
    end

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluent-bit
  namespace: amazon-cloudwatch
  labels:
    k8s-app: fluent-bit
spec:
  selector:
    matchLabels:
      k8s-app: fluent-bit
  template:
    metadata:
      labels:
        k8s-app: fluent-bit
    spec:
      containers:
      - name: fluent-bit
        image: amazon/aws-for-fluent-bit:2.23.4
        imagePullPolicy: Always
        env:
            - name: AWS_REGION
              valueFrom:
                configMapKeyRef:
                  name: cluster-info
                  key: logs.region
            - name: CLUSTER_NAME
              valueFrom:
                configMapKeyRef:
                  name: cluster-info
                  key: cluster.name
            - name: READ_FROM_HEAD
              valueFrom:
                configMapKeyRef:
                  name: cluster-info
                  key: read.head
            - name: READ_FROM_TAIL
              valueFrom:
                configMapKeyRef:
                  name: cluster-info
                  key: read.tail
            - name: HOST_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: FLB_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: cluster-info
                  key: log.level
        resources:
            limits:
              memory: 200Mi
            requests:
              cpu: 200m
              memory: 100Mi
        volumeMounts:
        # Please don't change below read-only permissions
        - name: fluentbitstate
          mountPath: /fluent-bit/state
        - name: varlog
          mountPath: /var/log
          readOnly: true
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: fluent-bit-config
          mountPath: /fluent-bit/etc/
        - name: runlogjournal
          mountPath: /run/log/journal
          readOnly: true
        - name: dmesg
          mountPath: /var/log/dmesg
          readOnly: true
      terminationGracePeriodSeconds: 10
      volumes:
      - name: fluentbitstate
        hostPath:
          path: /fluent-bit/state
        #emptyDir: {}
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      - name: fluent-bit-config
        configMap:
          name: fluent-bit-config
      - name: runlogjournal
        hostPath:
          path: /run/log/journal
      - name: dmesg
        hostPath:
          path: /var/log/dmesg
      serviceAccountName: fluent-bit
      tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
      - operator: "Exists"
        effect: "NoExecute"
      - operator: "Exists"
        effect: "NoSchedule"