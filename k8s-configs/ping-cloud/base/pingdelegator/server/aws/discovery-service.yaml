apiVersion: apps/v1
kind: Deployment
metadata:
  name: pingdelegator
spec:
  template:
    spec:
      initContainers:
      - name: pingdelegator-discovery-service
        image: public.ecr.aws/r2h3l6e4/pingcloud-clustertools/amazon/aws-cli:2.15.36
        imagePullPolicy: IfNotPresent
        command:
        - /bin/sh
        - -c
        - /get_ssm_env_vars.sh
        envFrom:
        - configMapRef:
            name: pingdelegator-environment-variables
        volumeMounts:
        - name: data-dir
          mountPath: /config
        - name: discovery-service
          mountPath: /get_ssm_env_vars.sh
          subPath: get_ssm_env_vars.sh
        - name: aws-config-dir
          mountPath: /.aws
        securityContext:
          runAsNonRoot: true
          runAsUser: 65534
          runAsGroup: 65534
          allowPrivilegeEscalation: false
          privileged: false
          readOnlyRootFilesystem: true
      volumes:
      - name: discovery-service
        configMap:
          name: discovery-service
          defaultMode: 0555